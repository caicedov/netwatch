// Copy this entire file to: apps/backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String    @unique @db.VarChar(20)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  email         String?   @unique @db.VarChar(255)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz(6)
  player Player?
  @@index([email], map: "idx_users_email")
  @@index([createdAt], map: "idx_users_created")
  @@map("users")
}

model Player {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  displayName  String   @map("display_name") @db.VarChar(50)
  energy       Int      @default(100)
  energyMax    Int      @default(100) @map("energy_max")
  money        BigInt   @default(0)
  experience   BigInt   @default(0)
  level        Int?     @default(0)
  skillPoints  Int      @default(0) @map("skill_points")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  computers         Computer[]
  hackOperations    HackOperation[]
  progressionUnlocks ProgressionUnlock[]
  @@index([userId], map: "idx_players_user")
  @@index([level], map: "idx_players_level")
  @@index([createdAt], map: "idx_players_created")
  @@map("players")
}

model Computer {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ownerId       String   @map("owner_id") @db.Uuid
  name          String   @db.VarChar(50)
  ipAddress     String   @unique @map("ip_address") @db.VarChar(15)
  storage       Int      @default(1000)
  cpu           Int      @default(100)
  memory        Int      @default(512)
  isOnline      Boolean  @default(true) @map("is_online")
  firewallLevel Int      @default(0) @map("firewall_level")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  owner          Player          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  defenses       Defense[]
  hackOperations HackOperation[]
  @@index([ownerId], map: "idx_computers_owner")
  @@index([ipAddress], map: "idx_computers_ip")
  @@index([isOnline], map: "idx_computers_online")
  @@map("computers")
}

model Defense {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  computerId   String      @map("computer_id") @db.Uuid
  defenseType  DefenseType @map("defense_type")
  level        Int         @default(1)
  effectiveness Decimal    @default(1.0) @db.Decimal(5, 2)
  installedAt  DateTime    @default(now()) @map("installed_at") @db.Timestamptz(6)
  computer Computer @relation(fields: [computerId], references: [id], onDelete: Cascade)
  @@unique([computerId, defenseType], map: "unique_defense_per_computer")
  @@index([computerId], map: "idx_defenses_computer")
  @@map("defenses")
}

model HackOperation {
  id                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  attackerId        String     @map("attacker_id") @db.Uuid
  targetComputerId  String     @map("target_computer_id") @db.Uuid
  status            HackStatus @default(PENDING)
  hackType          HackType   @map("hack_type")
  toolsUsed         Json       @default("[]") @map("tools_used") @db.JsonB
  estimatedDuration Int        @map("estimated_duration")
  startedAt         DateTime   @default(now()) @map("started_at") @db.Timestamptz(6)
  completionAt      DateTime   @map("completion_at") @db.Timestamptz(6)
  resultData        Json?      @map("result_data") @db.JsonB
  attacker       Player   @relation(fields: [attackerId], references: [id], onDelete: Cascade)
  targetComputer Computer @relation(fields: [targetComputerId], references: [id], onDelete: Cascade)
  @@index([attackerId], map: "idx_hack_attacker")
  @@index([targetComputerId], map: "idx_hack_target")
  @@index([status], map: "idx_hack_status")
  @@index([completionAt], map: "idx_hack_pending")
  @@map("hack_operations")
}

model ProgressionUnlock {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  playerId   String     @map("player_id") @db.Uuid
  unlockType UnlockType @map("unlock_type")
  unlockKey  String     @map("unlock_key") @db.VarChar(50)
  unlockedAt DateTime   @default(now()) @map("unlocked_at") @db.Timestamptz(6)
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  @@unique([playerId, unlockKey], map: "unique_player_unlock")
  @@index([playerId], map: "idx_unlocks_player")
  @@index([unlockKey], map: "idx_unlocks_key")
  @@map("progression_unlocks")
}

enum DefenseType {
  FIREWALL  @map("firewall")
  ANTIVIRUS @map("antivirus")
  HONEYPOT  @map("honeypot")
  IDS       @map("ids")
  @@map("defense_type")
}

enum HackStatus {
  PENDING     @map("pending")
  IN_PROGRESS @map("in_progress")
  SUCCEEDED   @map("succeeded")
  FAILED      @map("failed")
  ABORTED     @map("aborted")
  @@map("hack_status")
}

enum HackType {
  STEAL_MONEY    @map("steal_money")
  STEAL_DATA     @map("steal_data")
  INSTALL_VIRUS  @map("install_virus")
  DDOS           @map("ddos")
  @@map("hack_type")
}

enum UnlockType {
  TOOL    @map("tool")
  DEFENSE @map("defense")
  UPGRADE @map("upgrade")
  SKILL   @map("skill")
  @@map("unlock_type")
}
